recipe:
  id: "site-audit"
  name: "Comprehensive Site Audit"
  description: "Crawl website, analyze technical SEO issues, generate detailed report"
  cookbook: "seo-specialist-v1"
  version: "1.0.0"
  
  # Input schema (validated with Pydantic at runtime)
  inputs:
    - name: "website_url"
      type: "string"
      required: true
      validation: "url"
      description: "Target website URL to audit"
      example: "https://example.com"
    
    - name: "max_depth"
      type: "integer"
      required: false
      default: 3
      range: [1, 10]
      description: "Maximum crawl depth (number of link levels)"
    
    - name: "include_images"
      type: "boolean"
      required: false
      default: true
      description: "Include image analysis in audit"
  
  # Execution workflow (LangGraph DAG)
  workflow:
    nodes:
      # Node 1: Web Crawler
      - id: "fetch_pages"
        component: "WebCrawler"
        description: "Fetch and parse website pages"
        config:
          max_pages: 100
          max_depth: "{{ inputs.max_depth }}"
          respect_robots: true
          timeout: 30
          user_agent: "TeamAI-Bot/1.0"
        secrets:
          api_key: "secret:semrush_api_key"  # Fetched from Secret Locker
        
      # Node 2: LLM Analysis
      - id: "analyze_structure"
        component: "LLMProcessor"
        description: "Analyze site structure for SEO issues using LLM"
        config:
          model: "llama-3.1-8b-instant"
          fallback_model: "llama-3.3-70b-versatile"
          temperature: 0.3
          max_tokens: 2000
          prompt_template: |
            You are an expert SEO analyst. Analyze this website data and provide a detailed SEO audit report.
            
            **Website URL:** {{ inputs.website_url }}
            
            **Pages Crawled:** {{ fetch_pages.total_pages }}
            
            {% for page in fetch_pages.pages %}
            ---
            **Page:** {{ page.url }}
            - Title: {{ page.title or 'MISSING' }}
            - Meta Description: {{ page.meta_description or 'MISSING' }}
            - H1 Tags: {{ page.h1_tags | join(', ') or 'NONE' }}
            - H2 Tags: {{ page.h2_tags | join(', ') or 'NONE' }}
            - Word Count: {{ page.word_count }}
            - Images: {{ page.images }}
            - Internal Links: {{ page.links | length }}
            {% endfor %}
            
            Based on this data, provide:
            
            ## Executive Summary
            A brief overview of the website's SEO health (2-3 sentences).
            
            ## Critical Issues Found
            List specific issues found with severity (High/Medium/Low):
            - Missing or duplicate titles
            - Missing meta descriptions
            - Missing H1 tags
            - Low word count pages
            - Images without alt text
            
            ## Recommendations
            Provide 3-5 actionable recommendations to improve SEO, prioritized by impact.
            
            Be specific and reference actual data from the crawl.
        depends_on: ["fetch_pages"]
      
      # Node 3: Report Generator
      - id: "generate_report"
        component: "ReportGenerator"
        description: "Generate formatted SEO audit report"
        config:
          format: "markdown"
          template: "seo_audit_template.md"
          include_sections:
            - "executive_summary"
            - "critical_issues"
            - "recommendations"
            - "detailed_findings"
        depends_on: ["analyze_structure"]
      
      # Node 4: Subscription Tracker (MANDATORY - cannot be removed)
      - id: "track_usage"
        component: "SubscriptionTracker"
        description: "Meter execution for billing - mandatory compliance layer"
        config:
          # IDs injected at runtime by recipe evaluator
          agent_instance_id: "{{ runtime.agent_instance_id }}"
          recipe_id: "{{ runtime.recipe_id }}"
          agency_id: "{{ runtime.agency_id }}"
        depends_on: ["generate_report"]
        mandatory: true  # Cannot be bypassed
    
    # Define execution order (directed acyclic graph)
    edges:
      - from: "fetch_pages"
        to: "analyze_structure"
      - from: "analyze_structure"
        to: "generate_report"
      - from: "generate_report"
        to: "track_usage"
    
    # Final output specification
    output:
      type: "report"
      format: "markdown"
      source: "generate_report.output"
      filename: "seo_audit_{website_url}_{timestamp}.md"
  
  # Subscription tracking (mandatory for billing)
  compliance:
    track_usage: true
    billable_units: "per_execution"
    cost_per_unit: 0.50
    track_metrics:
      - "execution_time_ms"
      - "tokens_used"
      - "pages_crawled"
  
  # A/B testing configuration (product differentiator)
  ab_testing:
    enabled: true
    variants:
      - version: "1.0.0"
        description: "Original prompt template"
      - version: "1.1.0-beta"
        description: "Enhanced prompt with more specific instructions"
    success_metric: "quality_score"  # Options: quality_score, execution_time, token_cost
    sample_size: 100
